<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StarlightGG</title>
    <script src="https://cdn.tailwindcss.com"></script>
<link rel="icon" type="image/png" href="media/favicon.png">
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");

      /* * SOFT UI / LIGHT BLUE THEME 
       * Based on light background for neumorphism effect 
      */
      :root {
        --bg-light: #e0f7fa; /* Light Blue Background */
        --bg-medium: #ffffff; /* Brighter surface for elements */
        --primary-color: #00bcd4; /* Cyan/Light Blue Accent */
        --secondary-color: #00838f; /* Darker Cyan */
        --text-color: #212121;
        --text-secondary-color: #616161;
        --text-placeholder-color: #9e9e9e;
        --border-color: #bdbdbd;

        --font-family: "Poppins", sans-serif;
        --font-size: 16px;
        --border-radius: 16px;
        
        /* Neumorphism Shadows */
        --shadow-light: #ffffff;
        --shadow-dark: #b3d1d4;
      }

      body {
        background-color: var(--bg-light);
        color: var(--text-color);
        font-family: var(--font-family);
        font-size: var(--font-size);
      }

      /* Neumorphism Base Styles */
      .soft-ui {
        border-radius: var(--border-radius);
        background: var(--bg-medium);
        box-shadow: 8px 8px 16px var(--shadow-dark),
                   -8px -8px 16px var(--shadow-light);
        transition: all 0.3s ease;
      }
      
      .soft-ui-inset {
        border-radius: var(--border-radius);
        background: var(--bg-light);
        box-shadow: inset 5px 5px 10px var(--shadow-dark),
                    inset -5px -5px 10px var(--shadow-light);
        transition: all 0.3s ease;
      }

      /* Game Card Hover Effect (Press) */
      .soft-ui:hover {
        box-shadow: 4px 4px 8px var(--shadow-dark),
                   -4px -4px 8px var(--shadow-light);
        transform: translateY(-2px);
      }
      .soft-ui:active {
        box-shadow: inset 5px 5px 10px var(--shadow-dark),
                    inset -5px -5px 10px var(--shadow-light);
        transform: translateY(0);
      }
      
      /* Input specific neumorphic styling */
      .soft-ui-input {
          /* Use soft-ui-inset styling for inputs */
          padding: 1rem;
          border: none;
          color: var(--text-color);
          background-color: var(--bg-light);
      }

      /* Popup Styles Adaptation */
      .game-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* Darker overlay for focus */
        z-index: 9999;
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      .game-popup-container {
        width: 95%;
        height: 95%;
        max-width: 1400px;
        max-height: 900px;
        /* Popup uses the soft-ui style */
        background: var(--bg-medium);
        border-radius: var(--border-radius);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2), 
                    8px 8px 16px var(--shadow-dark),
                   -8px -8px 16px var(--shadow-light);
      }

      .game-popup-header {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-light); /* Header slightly lighter */
      }

      .game-popup-title {
        color: var(--text-color);
        font-size: 18px;
        font-weight: 600;
        flex: 1;
        text-align: center;
      }

      /* Neumorphic buttons in popup header */
      .game-popup-close,
      .game-popup-fullscreen {
        /* Use soft-ui-inset for button press effect */
        background: var(--bg-light);
        box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        border: none;
        color: var(--text-secondary-color);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 18px;
      }

      .game-popup-close:hover,
      .game-popup-fullscreen:hover {
        color: var(--primary-color);
      }
      .game-popup-close:active,
      .game-popup-fullscreen:active {
        box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
        transform: scale(0.95);
      }

      .game-popup-content {
        flex: 1;
        position: relative;
        background: var(--bg-light);
      }

      .game-popup-content iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      /* Loader */
      .game-popup-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border: 4px solid rgba(0, 188, 212, 0.2);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Tailwind Overrides for Color Consistency */
      .bg-gray-900 {
        background-color: var(--bg-light) !important;
      }
      .text-white {
        color: var(--text-color) !important;
      }
      .bg-gray-800 {
        background-color: var(--bg-medium) !important;
      }
      .text-gray-400 {
        color: var(--text-secondary-color) !important;
      }
      .border-gray-700 {
        border-color: var(--border-color) !important;
      }
      .focus\:border-purple-500:focus {
        border-color: var(--primary-color) !important;
      }
      .text-purple-500 {
        color: var(--primary-color) !important;
      }
      .text-gray-500 {
        color: var(--text-placeholder-color) !important;
      }
      
      /* Highlight Colors */
      .text-red-500 {
        color: #e57373 !important; /* Light Red */
      }
      .text-green-500 {
        color: #81c784 !important; /* Light Green */
      }
      .text-yellow-500 {
        color: #ffb74d !important; /* Light Orange */
      }
      .text-blue-500 {
        color: var(--primary-color) !important;
      }
      .bg-red-500 {
        background-color: #e57373 !important;
      }
      .bg-green-500 {
        background-color: #81c784 !important;
      }
      .bg-yellow-500 {
        background-color: #ffb74d !important;
      }
      .bg-blue-500 {
        background-color: var(--primary-color) !important;
      }
      
      /* Game Card Shadow */
      .hover\:shadow-purple-500\/50:hover {
        box-shadow: 4px 4px 8px rgba(0, 188, 212, 0.2), 
                   -4px -4px 8px var(--shadow-light) !important;
      }
    </style>
  </head>

  <script
    async
    src="https://www.googletagmanager.com/gtag/js?id=G-9NXH6G254G"
  ></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-9NXH6G254G");
  </script>

  <body class="bg-gray-900 text-white min-h-screen">
    <div x-data="gamesApp()" x-init="init()">
      <header class="p-6">
        <img
          src="media/favicon.png"
          alt="StarlightGG Logo"
          class="w-16 h-16 mx-auto mb-4"
        />
        <h1 class="text-4xl font-bold text-center">
          <span class="text-primary-color">StarlightGG</span>
        </h1>

        <p class="text-center mt-2 text-sm text-gray-400">v1.0.0 (Soft UI)</p>
      </header>

      <main class="container mx-auto p-4 max-w-7xl">
        <div class="mb-6 space-y-4">
          <input
            type="text"
            x-model="searchQuery"
            @input="applyFilters()"
            :placeholder="searchPlaceholder"
            class="soft-ui-inset w-full px-4 py-3 rounded-2xl focus:outline-none focus:border-primary transition"
          />

          <div class="text-center text-gray-400">
            <span x-text="filteredGames.length"></span> games available
          </div>
        </div>

        <div x-show="loading" class="text-center py-12">
          <i class="fa-solid fa-spinner fa-spin text-4xl text-purple-500"></i>
          <p class="mt-4 text-gray-400">Loading games...</p>
        </div>

        <div
          x-show="!loading && filteredGames.length === 0"
          class="text-center py-12"
        >
          <i class="fa-solid fa-circle-exclamation text-4xl text-gray-500"></i>
          <p class="mt-4 text-gray-400">No games found.</p>
        </div>

        <div
          x-show="!loading && filteredGames.length > 0"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6"
        >
          <template x-for="(game, index) in filteredGames" :key="index">
            <div
              class="soft-ui overflow-hidden shadow-lg hover:shadow-purple-500/50 cursor-pointer"
              @click="openGame(game)"
            >
              <div class="relative aspect-square bg-gray-700">
                <img
                  :src="getGameImage(game)"
                  :alt="game.name"
                  class="w-full h-full object-cover"
                  loading="lazy"
                />
                <div class="absolute top-2 left-2 flex flex-col gap-1">
                  <span
                    x-show="game.top"
                    class="bg-red-500 text-white text-xs px-2 py-1 rounded font-bold"
                  >
                    <i class="fa-solid fa-fire"></i> HOT
                  </span>
                  <span
                    x-show="game.new"
                    class="bg-green-500 text-white text-xs px-2 py-1 rounded font-bold"
                  >
                    <i class="fa-solid fa-sparkles"></i> NEW
                  </span>
                  <span
                    x-show="game.exp"
                    class="bg-yellow-500 text-white text-xs px-2 py-1 rounded font-bold"
                  >
                    <i class="fa-solid fa-vial"></i> EXP
                  </span>
                  <span
                    x-show="game.updated"
                    class="bg-blue-500 text-white text-xs px-2 py-1 rounded font-bold"
                  >
                    <i class="fa-solid fa-sparkles"></i> UPDATED
                  </span>
                </div>
              </div>

              <div class="p-3">
                <p
                  class="text-sm font-semibold text-center truncate"
                  x-text="game.name"
                ></p>
              </div>
            </div>
          </template>
        </div>
      </main>

      <div
        class="game-popup-overlay"
        x-show="popupOpen"
        @click.self="closePopup()"
      >
        <div class="game-popup-container">
          <div class="game-popup-header">
            <div style="width: 36px"></div>
            <div
              class="game-popup-title"
              x-text="currentGame?.name || 'Loading...'"
            ></div>
            <div style="display: flex; flex-direction: row; gap: 4px">
              <button class="game-popup-fullscreen" @click="refreshGame()">
                <i class="fa-solid fa-rotate-right"></i>
              </button>
              <button class="game-popup-fullscreen" @click="fullscreenPopup()">
                <i class="fa-solid fa-expand"></i>
              </button>
              <button class="game-popup-close" @click="closePopup()">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>
          <div class="game-popup-content">
            <div x-show="gameLoading" class="game-popup-loader"></div>
            <iframe
              x-ref="gameFrame"
              @load="gameLoading = false"
              style="display: none"
              x-show="!gameLoading"
            ></iframe>
          </div>
        </div>
      </div>
      <footer class="mt-12 py-6 text-center text-gray-500 text-sm">
        <p>StarlightGG Hub</p>
      </footer>
    </div>

    <script>
      const cdnUrl = "https://lucdn.eduwing.org";
      const cdnUrl2 = "https://corsproxy.io/?url=";

      function gamesApp() {
        return {
          allGames: [],
          filteredGames: [],
          searchQuery: "",
          searchPlaceholder: "Search for games",
          loading: true,
          popupOpen: false,
          gameLoading: true,
          currentGame: null,
          // Removed: showWarningModal

          async init() {
            // Removed: showWarningModal logic

            console.log(
              "%cLunaar%c Lite v1.0.0 - Loading...",
              "font-size: 16px; background-color: #00bcd4; border-radius: 5px 0 0 5px; padding: 4px; font-weight: bold; color: white;",
              "font-size: 16px; background-color: #e0f7fa; font-weight: bold; padding: 4px; border-radius: 0 5px 5px 0; color: #212121;"
            );

            try {
              const responses = await Promise.allSettled([
                fetch("./json/games.json").then((r) => r.json()),
                fetch(cdnUrl2 + "https://lucdn.eduwing.org/cdn/all").then((r) =>
                  r.json()
                ),
              ]);

              this.allGames = responses
                .filter((r) => r.status === "fulfilled")
                .flatMap((r) => r.value);

              console.log(`Loaded ${this.allGames.length} games`);
              this.searchPlaceholder = `Search for ${this.allGames.length} games`;
              this.applyFilters();
            } catch (error) {
              console.error("Error loading games:", error);
            } finally {
              this.loading = false;
            }
          },

          applyFilters() {
            let filtered = this.allGames;

            if (this.searchQuery) {
              filtered = filtered.filter((game) =>
                game.name.toLowerCase().includes(this.searchQuery.toLowerCase())
              );
            }

            filtered = [...filtered].sort((a, b) => {
              if (a.name === "Request a game") return -1;
              if (b.name === "Request a game") return 1;
              if (a.new && !b.new) return -1;
              if (!a.new && b.new) return 1;
              if (a.top && !b.top) return -1;
              if (!a.top && b.top) return 1;
              return 0;
            });

            this.filteredGames = filtered;
            this.searchPlaceholder = `Search for ${filtered.length} game${
              filtered.length !== 1 ? "s" : ""
            }`;
          },

          getGameImage(game) {
            if (game.image?.startsWith("https://")) {
              return game.image;
            }
            if (game.proxy) {
              return cdnUrl + `/media/games/${game.image}`;
            } else {
              const firstSegment = game.url?.split("/")[0] || "";
              return cdnUrl + `/cdn/${firstSegment}/${game.image}`;
            }
          },

          async openGame(game) {
            console.log("Opening game:", game.name);
            this.currentGame = game;
            this.popupOpen = true;
            this.gameLoading = true;

            await this.$nextTick();
            const iframe = this.$refs.gameFrame;
            console.log("Iframe ref:", iframe);
            
            // This is the core logic that re-opens the game
            this.loadIframeContent(iframe, game);
          },
          
          async loadIframeContent(iframe, game) {
             if (game.url?.includes("jsdelivr")) {
              try {
                const response = await fetch(game.url);
                const html = await response.text();
                iframe.style.display = "block";
                iframe.contentDocument.open();
                iframe.contentDocument.write(html);
                iframe.contentDocument.close();
                this.gameLoading = false;
              } catch (error) {
                console.error("Error loading jsdelivr content:", error);
                this.gameLoading = false;
              }
            } else if (!game.proxy) {
              iframe.style.display = "block";
              iframe.src = cdnUrl + `/cdn/${game.url}/`;
            } else {
              iframe.style.display = "block";
              iframe.src = game.url;
            }
          },

          // NEW: Function to reload the game in the iframe
          refreshGame() {
            console.log("Refreshing game:", this.currentGame?.name);
            if (this.currentGame) {
              // Re-run the loading process
              const iframe = this.$refs.gameFrame;
              iframe.src = "about:blank"; // Clear the iframe first
              this.gameLoading = true;
              this.loadIframeContent(iframe, this.currentGame);
            }
          },

          closePopup() {
            console.log("Closing popup");
            this.popupOpen = false;
            this.currentGame = null;
            this.gameLoading = true;

            const iframe = this.$refs.gameFrame;
            if (iframe) {
              iframe.src = "about:blank";
              iframe.style.display = "none";
            }
          },

          fullscreenPopup() {
            const iframe = this.$refs.gameFrame;
            if (iframe.requestFullscreen) {
              iframe.requestFullscreen();
            } else if (iframe.mozRequestFullScreen) {
              iframe.mozRequestFullScreen();
            } else if (iframe.webkitRequestFullscreen) {
              iframe.webkitRequestFullscreen();
            } else if (iframe.msRequestFullscreen) {
              iframe.msRequestFullscreen();
            }
          },
        };
      }
    </script>
  </body>
</html>
